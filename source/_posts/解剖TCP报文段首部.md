---
title: 解剖TCP报文段首部
date: 2018-01-13 20:11:33
categories: "网络协议" 
tags: [TCP,网络协议]
---

>TCP的全部功能都体现在它首部各个字段的作用。只有弄清TCP首部各个字段的作用才能掌握TCP原理。

<!-- more -->  

TCP报文首部的前20个字节是固定的，后面有4n个字节是根据需要而增加的。因此TCP报文首部的最小长度是20字节。 TCP报文段的首部格式如下：

![TCP报文段首部格式](https://wx3.sinaimg.cn/mw690/857afa84ly1fokp79c7cwj20dw095wex.jpg)


首部各字段意义如下：  
**源端口和目的端口**：各占2个字节。  

**序号**：占4个字节。序号范围是0至4294967295，工4294967296个序号。序号增加到4294967295后，下一个序号就回到0。TCP是面向字节流的。在TCP连接中传输的每个字节都按顺序编号。整个要传送的字节流的起始序号必须在连接建立时设置。首部中的序号字段值，指的是本报文段所发送的数据的第一个字节的序号。例如，一个报文段的序号值是101，而鞋带的数据共有100字节。这就说明了最后一个字节的序号是200。那么下一个报文段的序号应该从201开始。  

**确认号** ： 占4个字节，是期望收到对方下一个报文段的第一个数据字节的序号。例如，B正确收到A发送过来的一个报文段，报文序号值是301，而数据长度是200字节（301~500），B期望收到A的下一个数据序号是501，于是B在发送给A的确认报文段中，把确认号置为501。  
由于序列号字段有32位长，可对4GB（即4千兆字节）的数据进行编号。在一般情况下可以保证序号重复使用时，旧的序号已经到达网络终点了。

**数据偏移** ：占4位，它指出TCP报文段的数据起始处距离TCP报文段的起始位置有多远。这个字段实际是指TCP报文段首部长度。由于首部中还有长度不确定的选择字段，因此数据偏移字段是必须的。需要注意的是“数据偏移”的单位是32位字（即4字节长的字为计算单位）。由于4位二进制数能够表示的最大十进制数字是15，因此数据偏移的最大值为60字节，这也是TCP首部的最大长度（即选项长度不能超过40自己）。

**保留** :占6位，保留为今后使用，目前应置为0

> 下面介绍6个控制位，在TCP报文段首部用来表示报文段的性质

**紧急URG** :当URG=1时，表明紧急指针有效。它告诉系统此报文段有紧急数据要尽快传送，而不要按原来的排队顺序来。系统会把紧急数据插入到本报文段的最前面，而不是放在TCP缓存的末尾。这时，还需要和紧急指针配合使用。

**确认ACK** ：仅当ACK=1时，确认号字段有效。当ACK=0时，确认号无效。TCP规定，在简历连接后，所有报文段都必须把ACK置1.

**推送PSH** ：当两个应用进程进行交互通信时，有时一端的应用进程希望在键入一个命令后立即就能收到对方的响应。这种情况下就可以用PUSH操作。这时发送方TCP把PSH置1，并立即创建一个报文段发送出去。接收方TCP收到PSH=1的报文段，就尽快地交付接收应用进程，而不再等待整个缓存区满了后再向上交付。

**复位RST** :当RST = 1时，表明TCP连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后重新建立连接。RST置1还用来拒绝一个非法报文或拒绝打开一个连接。RST又叫做重置位。

**同步SYN** : 在连接建立时用来同步序号。SYN=1，ACK=0表明这是一个连接请求。若对方同意连接，会把SYN和ACK都置1.

**FIN终止位** ：用来释放一个连接。当FIN = 1时，表明报文段的发送方的数据已经发送完毕。

**窗口** ：占2字节，即16位。窗口指的是发送本报文段的一方的**接收窗口**，而不是自己的发送窗口。窗口值告诉对方，从本报文段首部的确认号算起，接收方目前允许对方发送的数据量。之所以有这个限制，是因为接收方的数据缓存空间是有限的。总之，窗口致作为接收方让发送方设置其发送窗口的依据。

**校验和** ：TCP校验和是一个端到端的校验和，由发送端计算，然后由接收端验证。其目的是为了发现TCP首部和数据在发送端到
接收端之间发生的任何改动。如果接收方检测到校验和有差错，则TCP段会被直接丢弃。

**紧急指针** ：占2字节。紧急指针仅在URG=1时才有意义，它支持本报文段中的紧急数据的字节数，指向紧急数据末尾在报文段中的位置。当紧急数据处理完时，TCP就告诉应用程序恢复正常操作。



> 下面介绍3个选项，分别是最大报文长度MSS，窗口扩大选项，时间戳。

**选项** 长度可变，最长可达40字节。当没有使用“选项”时，TCP的首部长度是20字节。  

**最大报文长度MSS**：TCP选项最初只规定了一种选项，就是**最大报文长度MSS**。MSS是每个TCP报文段中数据段的最大长度。数据字段加上首部字段才是整个TCP报文段。
若选择较小的MSS长度，网络的利用率会降低。如选择较大的MSS，则在IP层传输时可能要分解成多个短数据报片。在终点又需要把短数据报片装配成原来的TCP报文段。这会增大开销。

**窗口扩大选项**是为了扩大窗口。我们知道，TCP首部中窗口字段长度是16位。因此最大窗口大小为64k字节。为了获得搞吞吐率，需要更大的窗口。窗口扩大选项占3个字节，其中一个字节表示位移值S，位移值最大为14。新的TCP窗口的最大值位数从16增加到30。窗口扩大选项可以在双方初始建立TCP连接时协商。

**时间戳**： 时间戳选项占10个字节，主要有以下两个功能：
第一：用来计算往返时间RTT。发送方把发送时的时间戳放入报文首部，接收方在确认该报文时把时间戳放入报文首部。那么发送方收到确认时，就可以准确计算出RTT.

第二：用于处理TCP序号超过2的32次方的情况，这又称为序号绕回。因为序号只有32位，每增加2的32次方个序号就会重新使用已经用过的序号。在高速传输的网络中，很容易出现序号绕回的情况。为了把新旧报文区分开，我们可以使用时间戳选项。


## 参考资料

[《计算机网络》](https://book.douban.com/subject/2970300/) 