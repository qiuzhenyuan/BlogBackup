---
title: 说说TCP的“三握四挥”
date: 2017-07-04 10:58:23
tags: [网络协议]
---

>TCP的“三次握手”与“四次挥手”是程序员面试中，出场率最高的问题了。今天就简单地说一下。


## 建立TCP连接
TCP连接的建立，需要三次握手才能完成。SYN与ACK是TCP段中不同类型的元数据。SYN用于标志报文，以方便报文进行重组。ACK表示“确认收到”，是接收方计算机告诉发送方计算机“好，已收到”的方式。  

<!-- more -->   
### 连接的建立  
**第一步:** 节点A向节点B发送一条初始化报文。该报文将SYN位置位。节点B收到报文，发现SYN位已置为1（二进制表示打开），此时节点B知道节点A正尝试与自己建立连接。  
**第二步：** 假设节点B有足够的资源，它会向节点A回复一个报文，并将报文的SYN与ACK置位。其中SYN位表示“我想与你同步”，ACK位表示“我确认收到你发送的SYN”请求。  
**第三步：** 节点A向节点B发送另一个报文，并将ACK位置位，从而告知节点B“我已经收到你的请求”。  
于是三次握手就完成了，可以进行数据传输。  

![三次握手示意图](https://wx4.sinaimg.cn/mw690/857afa84gy1fm9ghlrprcj20l30gt0t3.jpg)

### 序列号与应答号
前面说到了标志位SYN与ACK,分别表示“我想与你建立连接”和“我确认收到你的请求”的意思。这部分我们来讲一下SEQ(序列号)与ACK（应答号）。他们位于TCP头部的不同字段，不能混淆。

**第一步:** 节点A发送一个TCP SYN报文，告诉节点B它想建立一条连接。报文的序列号（SEQ)设置为J。    
**第二步：** 节点B向节点A返回一个SYN/ACK 报文作为回复。报文选择的序列号（SEQ)为K（一个随机数），而确认号为J+1，表示**节点B已经收到序列号为J的TCP SYN报文，并准备好接收序列号为J+1的下一个报文** 。   
**第三步：** 最后一步节点A向节点B发送一个确认报文，以响应节点B发送给节点A的SYN报文。节点A的确认号（ACK）为K+1表示节点A已经接收到节点B序列号（SEQ)为K的报文。由于节点B向节点A发送了一个确认号为J+1的报文，节点A知道自己可以发送下一个报文，并将序列号设置为J+1。   

![三次握手的序列号与应答号](https://wx2.sinaimg.cn/mw690/857afa84gy1fm9ghjp1isj20l20gtmxi.jpg)

## 关闭TCP连接

建立一条TCP连接需要三个报文（段），而关闭一条TCP连接需要四个报文（段）。这是由TCP的 **半关闭** 导致的。TCP连接是全双工的（两个方向的数据流互相独立），每个方向都需要独立地关闭。  
**第一步:** 节点A首先调用关闭，这一端执行**主动关闭** ，TCP发送FIN段，表示它已经发送完数据。  
**第二步：** 节点B收到FIN，执行**被动关闭** 。TCP对FIN进行应答。FIN的接收，意味着节点B这个连接上不会再接收到数据。  
**第三步：** 在节点B自己发送完数据后，向对方发送FIN。  
**第四步：** 节点B收到节点A发过来的应答ACK。四次挥手完成。  

![四次挥手](https://wx3.sinaimg.cn/mw690/857afa84gy1fm9h4hfowmj20l30i13yv.jpg)

## 参考资料
《计算机网络基础教程》  
