---
title: TCP的滑动窗口
date: 2018-01-19 16:54:54
categories: "网络协议" 
tags: [TCP,网络协议]
---

## 简介

TCP 的滑动窗口主要有两个作用： 一是提供TCP的**可靠性**；二是提供TCP**流控特性**。   

TCP的滑动窗口是以**字节**(byte)为单位的。

TCP窗口大小值是TCP段中一个16bit字段，它代表窗口的字节容量。TCP窗口的最大值为2的16次方，即65535字节。  
接受者在回复给发送者的每一个确认信息中都通告了自己的窗口大小。这个确认信息可以是报文段，即纯确认信息。也可以被捎带在反向的报文段中传送给发送者。这个窗口的大小，其实是接受者缓存中剩余的空间大小。

<!-- more -->  



## 窗口构成

对于TCP会话**发送端**，任何时候在发送缓存内的数据可以分为4类：

１.　已经发送并得到对端ACK;

２.　已经发送但还没收到ACK;

３.　未发送但对端允许发送；

４.　未发送而对端不允许发送；

我们把“已经发送但还未收到对端ACK的”和“未发送但对端允许发送的”这两部分数据称为发送窗口

![发送窗口示意图](https://wx2.sinaimg.cn/mw690/857afa84ly1fns3f6dtaej20kc03ldhs.jpg)



对于TCP 的**接收方**，在某一时刻它的接受缓存内的数据可以分为3类：

１.　已接收；

２.　未接收准备接收；

３.　未接收不准备接收；

其中“未接收准备接收”称为接收窗口。



## 窗口的移动

TCP是全双工的协议，会话的双方都可以同时接收、发送数据。TCP的双方都维护一个“发送窗口”和一个“接收窗口”。其中各自的“接收窗口”大小取决于应用、系统、硬件的限制（TCP传输的数据不能大于应用的数据处理速率）。各自的“发送窗口”则要求取决于对端通告的窗口大小值。

发送窗口的位置由窗口**前沿**和**后沿**的位置共同确定。发送窗口的后沿有两种可能，即不动（没有收到新的确认）和前移（收到了新的确认）。发送窗口的后沿不可能往后，因为不可能撤销确认。滑动窗口的前沿可能通常是不断向前移动。但也有可能不动，这对应于两种情况：一是没有收到新的确认；二是收到新的确认，但是窗口之缩小了。滑动窗口的前沿也有可能后退，原因是对方通知的窗口之缩小的字节数，大于上一次收到确认号的字节数。但是TCP强烈不建议这么做，因为有可能在收到这个通知之前，已经发送了窗口的大量数据。

对于不按序到达的数据，TCP同常先把它们临时存放在接收窗口中，等字节流中所缺少的字节收到后，再按序交付上层的应用进程。

滑动窗口机制的可靠性简历再“确认重传”的基础上。只有收到发送窗口内字节的ACK确认，才会移动发送窗口的左边界，否则不会移动边界。这样确认了传输失败的段可以得到重传。



## 滑动窗口与流量控制

利用滑动窗口实现流量控制，本质就是让发送方的发送速率不要太快，让对方**来得及接收**。发送方的发送窗口**不能超过**接收方给出的**接收窗口的数值**。下面通过一个例子来说明这个过程：

设A与B通信。在连接建立时，B告诉A：“我的接收窗口 rwnd =400"(这里rwnd表示receiver window)，因此发送方的发送窗口不能超过接收方给出的接收窗口的数值。

设每个报文段为100字节常，数据报文段的序号初始值设为1

![流量控制过程](https://wx1.sinaimg.cn/mw690/857afa84ly1fns3ske59sj20hv09j769.jpg)

可以看到，接收方主机B进行了三次流量控制。第一次把窗口减小到 rwnd=300，第二次又减少到rwnd=100，最后减少到0，即不允许对方再发数据。

现在考虑一种情况，B向A发送了rwnd=0的报文段后，过一段时间又有了缓存空间。于是B向A发送了rwnd=400的报文段。然而这个报文段在传输过程中丢失了。那么A和B就会陷入相互等待的死锁中。

为了解决上述的死锁问题，TCP为每一个连接舍友一个持续计时器。只要TCP连接的一方收到对方的零窗口通知，就会启动持续计时器。若时间到，就会发送一个零窗口探测报文段，而对方在收到这个零窗口探测报文后，会给出现在的窗口值。如果这个窗口值不是零，那么死锁僵局就会被打破。



## 参考资料

[《计算机网络》](https://book.douban.com/subject/2970300/) 

[《后台开发核心技术与应用实践》](https://book.douban.com/subject/26850616/)