---
title: 深入理解查询优化 | 逻辑优化
date: 2018-02-17 22:59:40
categories: 数据库
tags: [查询优化]
---

## 简介
逻辑优化要解决的问题是：如何找出SQL语句等价的变换形式，使SQL执行更加高效。逻辑优化主要做的事情，就是对查询进行重写。查询重写的理论基础是**关系代数**。  

<!-- more -->



## 基本操作的优化

传统OLTP数据库使用基于选择（SELECT)、投影（PROJECT)、连接（JOIN）3种基本操作结合的查询。这些三种基本操作的优化方式如下：

**选择操作**：选择对应着**限制条件**。优化的方式是选择操作下推，目的是减少连接操作之前的元组数，使得中间的临时关系**尽量少**（元组数少，连接得到的元组数就少），这就可以减少IO消耗，节约内存空间。

**投影操作**：投影操作对应着SELECT 查询的目的列对象，优化方式是投影操作下推，目的是减少连接操作前的列数，使得中间临时关系**尽量小**（特别注意差别：选择操作是是元组个数“尽量少”，投影操作是使一条元组“尽量小”）。

**连接操作**：连接操作对应的是连接条件。多表连接中每个表被连接的顺序决定着效率。多表连接每个表被连击的顺序由语义决定，表之间的连接顺序是不能随意交换的。

选择和投影操作可以在关系代数规则的知道下进行优化。表连接需要多表连接的相关算法完成优化。



## 常见逻辑优化

### 外连接消除

逻辑优化的一个重要技术，就是把**外连接**转化为**内连接**。外连接包括全外连接，左外连接和右外连接。转换为内连接的意义如下：

1. 查询优化器处理外连接所需要的时间和操作多与内连接（元组数更多）；
2. 优化器在选择连接顺序时可以更灵活，因为内连接的顺序可以调整，外连接不可以；
3. 表的一些连接算法（如块嵌套连接算法）将规模小的或筛选条件最严格的表作为“外表”（放在连接顺序的最前面，是多层循环的外循环层），可以减少不必要的IO 开销。



> **内联接**：结果集中，只包含满足连接条件的行。
>
> **左外联接**：结果集中包括左表所有的行，而不仅仅包括满足连接条件的行。如果左表的某行在右表中没有匹配行，则该行右表所有的选择列都为空值
>
> **右外联接**：右连接时左连接的反向连接，与左连接同理。
>
> **全外联接**：返回左表和右表的所有行。如果某行在另一个表没有匹配行时，则另一个表的选择列包含空值。




#### 什么时候可以消除外连接

|      | A             | B                     | C                      |
| ---- | ------------- | --------------------- | ---------------------- |
| 内连接  | matched pairs |                       |                        |
| 左外连接 | matched pairs | unmatched left tuples |                        |
| 右外连接 | matched pairs |                       | unmatched right tuples |
| 全外连接 | matched pairs | unmatched left tuples | unmatched right tuples |



观察左外连接与内连接，我们可以知道，左外连接比内连接多出了B部分。就是不满足连接条件的，左表中的元组。

假设一个左连接执行后，它的结果等同于一个内连接，那么它就是可以转换为内连接的。

但是这种转换是有条件的，条件是：保证最后的结果集中不会B部分的元组（这样的条件称为“reject-NULL"条件，即**空值拒绝**）。

右外连接和全外连接也可以转化为内连击，转化的条件同理，也是要满足**空值拒绝**。



#### 空值拒绝

前面提到，外连接转换为内连接的条件是：WHERE 字句中与内表相关的条件满足“空值拒绝”（reject-NULL条件）。那么条件怎么才算是满足空值拒绝呢？一般认为满足一下任何一种情况是，即满足空值拒绝：

1. 条件可以保证从结果中排除外连接的右侧（右表）生成的值为NULL的行（即条件确保应用在右表带有空值的列对象是，条件不满足），所以能使该查询在语义上等效于内连接。
2. 外连接的提供空值的一侧为另一侧的每行只返回一行。如果该条件为真，则不存在提供控制的行。



#### 例子

初始数据

```sql
CREATE TABLE X (X_num int, name varchar(10));
CREATE TABLE Y (Y_num int, name varchar(10));
INSERT INTO X VALUES(1, 'X_1');
INSERT INTO X VALUES(2, 'X_2');
INSERT INTO X VALUES(NULL, 'X_3');
INSERT INTO Y VALUES(1, 'Y_1');
INSERT INTO Y VALUES(NULL, 'Y_2');
INSERT INTO Y VALUES(3, 'Y_3');
```



我们来分析下面两条查询语句：

语句一：

```sql
SELECT  * FROM X LEFT JOIN Y ON (X.X_num = Y.Y_num);
```

只有连接条件`X.X_num = Y.Y_num` ，没有WHERE条件，没有被优化。

语句二：

```sql
SELECT * FROM X LEFT JOIN Y ON (X.X_num=Y.Y_num) WHERE Y.Y_num is NOT NULL;
```

语句二包含`Y.Y_num is NOT NULL` ,的条件，则Y被选中的列为NULL的元组不会出现在最终结果集中。满足空值拒绝的条件。因此这个左外连接会被优化成内连接。



### 等价谓词重写

在数据库执行引擎中，一部分谓词的执行效率要高于另外的谓词。因此等价谓词重写也是一种有效的查询优化方式。



#### LIKE 规则

LIKE谓词是SQL标准支持的一种模式匹配操作。针对LIKE规则的优化如下：

```sql
name LIKE 'abc%'
```

重写为：

```sql
name >= 'abc' AND name < 'abd'
```

这样转换的好处是：LIKE规则只能进行全表扫描，转换后若name列上存在索引，则可以利用索引进行扫描。



#### BEWEEN-AND 规则

BETWEEN-AND规则的优化与LIKE类似：

```sql
id BETWEEN 10 AND 20
```

重写为：

```sql
id >= 10 AND id <= 20
```

可以利用索引扫描。



#### IN 转换 OR 规则

IN只是IN操作符操作，不是IN子查询。将IN谓词等价重写为若干个OR 谓词，可能提高执行效率。如：

```sql
age IN (8, 12, 21)
```

重写为：

```sql
age = 8 OR age = 12 OR age = 21
```

应用IN转换OR规则后，效率能否提高，主要取决于数据库是否只对IN操作符支持全表扫描。



### 子查询优化

#### 子查询合并

当多个子查询产生同样的结果集，就可以把多个子查询合并成一个子查询（合并后仍是一个子查询，但可以通过其他方式消除子查询）。如

```sql
SELECT * FROM t1 WHERE a1<10 AND (
EXISTS (SELECT a2 FROM t2 WHERE t2.a2<5 AND t2.b2=1) OR
EXISTS (SELECT a2 FROM t2 WHERE t2.a2< AND t2.b2=2)
)
```

可以优化为：

```sql
SELECT * FROM t1 WHERE t2.a2<5 AND (t2.b2=1 OR t2.b2=2)
```





#### 子查询展开

子查询展开，又称子查询反嵌套或子查询上拉。把一些在内层的子查询拉出来，置于外层的父查询中，作为连接关系与外层父查询并列，本质是把某些**子查询重写为等价的多表连接操作**。这样的好处是**有关连接方法，连接顺序的逻辑优化手段都可以得到应用**。优化的例子如下：

```sql
SELECT * FROM t1,(SELECT * FROM t2 WHERE t2.a2>10)v_t2 WHERE t1.a1 < 10 AND v_t2.a2<20
```

可以优化为：

```sql
SELECT * FROM t1,t2 WHERE t2.a2>10 AND t1.a1<10 AND t2.a2<20
```







## 参考

 [《数据库查询优化器的艺术》](https://book.douban.com/subject/25815707/ "《数据库查询优化器的艺术》")  

 [《数据库系统实现》 ](https://book.douban.com/subject/25815707/ "《数据库系统实现》 ")  

 [《数据库系统概念》 第五版](https://book.douban.com/subject/1929984/ "《数据库系统概念》 第五版")  